# ===========================================
# PROMTAIL CONFIGURATION
# ===========================================
# Promtail reads log files and ships them to Loki
# This config preserves raw JSON logs (no formatting applied)
# All JSON fields remain queryable in Grafana

# === SERVER ===
# Promtail's own HTTP server for metrics and status
server:
  http_listen_port: 9080  # Metrics available at http://localhost:9080/metrics
  grpc_listen_port: 0     # Not needed
  log_level: info

# === POSITIONS ===
# Tracks which log lines have been read to prevent duplicates after restart
# Format: /path/to/file.log: <byte_offset>
positions:
  filename: /tmp/positions.yaml

# === LOKI CLIENT ===
# Where to send the logs
clients:
  - url: http://loki:3100/loki/api/v1/push
    timeout: 30s
    backoff_config:
      min_period: 500ms  # Retry delay on failure
      max_period: 5m
      max_retries: 10

# === SCRAPE CONFIGS ===
# Defines which logs to collect and how to process them
scrape_configs:
  - job_name: spring-boot-logs

    static_configs:
      - targets:
          - localhost

        labels:
          environment: local
          # __path__ is a SPECIAL label that tells Promtail which files to watch
          # Supports glob patterns: *.log matches all .log files
          # This is NOT just metadata - it's the actual file filter
          __path__: /var/log/spring-boot/*.log

    # === PIPELINE ===
    # Processes each log line before sending to Loki
    # This pipeline extracts minimal fields but preserves the original JSON
    pipeline_stages:
      # STAGE 1: Parse JSON and extract specific fields
      # Non-JSON lines are skipped gracefully
      - json:
          expressions:
            ts: ${LOCALOBS_TIMESTAMP_SOURCE}  # Timestamp field from env var
            level: level                       # Log level (INFO, ERROR, etc.)
            application: application           # App name

      # STAGE 2: Convert timestamp string to actual timestamp
      # Format uses Go reference time: Mon Jan 2 15:04:05 MST 2006
      - timestamp:
          source: ts
          format: ${LOCALOBS_TIMESTAMP_FORMAT}      # e.g., 2006-01-02T15:04:05.999-0700
          location: ${LOCALOBS_TIMESTAMP_LOCATION}  # Timezone, e.g., America/Bogota

      # STAGE 3: Attach labels for efficient filtering in Loki
      # These become indexed labels you can query: {level="ERROR"}
      - labels:
          level:
          application:

      # STAGE 4: No template stage
      # Original JSON line is sent as-is to Loki
      # Query with: {job="spring-boot"} | json to parse all fields on demand
