services:
  # ===========================================
  # LOKI - Log Aggregation System
  # ===========================================
  # Loki is like a database for logs. It receives logs from Promtail and stores them efficiently.
  # Unlike traditional logging systems, Loki only indexes metadata (labels), not the log content,
  # making it fast and cheap to run.
  loki:
    # Using a specific version (2.9.3) for consistency
    image: grafana/loki:2.9.3
    container_name: loki
    
    # Expose port 3100 for:
    # - Receiving logs from Promtail via HTTP API (/loki/api/v1/push)
    # - Serving log queries from Grafana (/loki/api/v1/query_range)
    # - Health checks (/ready)
    ports:
      - "3100:3100"
    
    volumes:
      # Mount custom configuration file
      # This configures storage, retention, limits, and how Loki processes logs
      # See config/loki-config.yaml for details about storage schema, retention, etc.
      - ./config/loki-config.yaml:/etc/loki/local-config.yaml
      
      # Named volume for persistent storage of log data
      # Loki stores logs in "chunks" (compressed log data) and an "index" (metadata for queries)
      # Without this volume, all logs would be lost when container stops
      # Data location inside container: /tmp/loki (configurable in loki-config.yaml)
      - loki-data:/tmp/loki
    
    # Tell Loki to use our custom config file instead of defaults
    command: -config.file=/etc/loki/local-config.yaml
    
    # Private network shared by all three services so they can communicate
    networks:
      - loki-network
    
    # Restart policy: always restart unless manually stopped
    # Useful for development - survives system reboots and crashes
    restart: unless-stopped
    
    # Health check: Docker will mark service as "healthy" or "unhealthy"
    # Other services use this to wait until Loki is ready before starting
    healthcheck:
      # Command to check if Loki is ready to accept requests
      # /ready endpoint returns 200 when Loki is fully initialized
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s      # Check every 10 seconds
      timeout: 5s        # Fail if check takes longer than 5 seconds
      retries: 5         # Mark unhealthy after 5 consecutive failures

  # ===========================================
  # PROMTAIL - Log Shipper (Collector)
  # ===========================================
  # Promtail reads log files from disk, processes them (parse JSON, extract labels),
  # and ships them to Loki. Think of it as the "delivery truck" for logs.
  promtail:
    # Using matching version with Loki (important for compatibility)
    image: grafana/promtail:2.9.3
    container_name: promtail
    
    # Expose port 9080 for:
    # - Prometheus metrics about Promtail's operation (/metrics)
    # - Troubleshooting: see how many logs sent, errors, etc.
    ports:
      - "9080:9080"
    
    volumes:
      # Mount Promtail configuration
      # Defines: which files to read, how to parse them, where to send them
      # See config/promtail-config.yaml for pipeline stages (JSON parsing, labeling, etc.)
      - ./config/promtail-config.yaml:/etc/promtail/config.yml
      
      # Mount log directory from host (read-only ":ro" for safety)
      # Promtail watches ./logs/*.log files on your machine
      # Maps to /var/log/spring-boot inside container (as configured in promtail-config.yaml)
      - ./logs:/var/log/spring-boot:ro
      
      # Named volume for positions file - THIS IS CRITICAL!
      # Promtail tracks which lines it has already read in "positions.yaml"
      # Why it matters:
      # - Prevents sending duplicate logs after restart
      # - Remembers file positions across container restarts
      # - If you delete this volume, Promtail re-reads entire log files from beginning
      # Location configured in promtail-config.yaml: positions.filename: /tmp/positions.yaml
      - promtail-positions:/tmp
    
    # Tell Promtail to use our custom config file
    command: -config.file=/etc/promtail/config.yml
    
    # Same network as Loki so it can send logs via http://loki:3100
    networks:
      - loki-network
    
    # Wait for Loki to be healthy before starting Promtail
    # Prevents errors if Promtail tries to send logs before Loki is ready
    depends_on:
      loki:
        condition: service_healthy
    
    restart: unless-stopped

  # ===========================================
  # GRAFANA - Visualization & Query Interface
  # ===========================================
  # Grafana provides the web UI where you can query logs, create dashboards,
  # and visualize log data. It connects to Loki as a data source.
  grafana:
    # Using specific version for consistency
    image: grafana/grafana:10.2.3
    container_name: grafana
    
    # Expose port 3000 for web UI
    # Access at http://localhost:3000
    ports:
      - "3000:3000"
    
    # Environment variables for Grafana configuration
    environment:
      # Default credentials (CHANGE IN PRODUCTION!)
      # Login with admin/admin, Grafana will prompt to change password
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      
      # Disable user sign-up (only admin can access)
      # Set to true if you want others to create accounts
      - GF_USERS_ALLOW_SIGN_UP=false
      
      # Base URL for Grafana (used in links and redirects)
      # Change if accessing from different domain
      - GF_SERVER_ROOT_URL=http://localhost:3000
      
      # Log level for Grafana's own logs (visible in container logs)
      # Options: debug, info, warn, error
      - GF_LOG_LEVEL=info
    
    volumes:
      # Named volume for Grafana's persistent data
      # Stores: dashboards, users, preferences, plugins, etc.
      # Without this, you'd lose all dashboards and settings on restart
      - grafana-data:/var/lib/grafana
      
      # Auto-provision Loki as a data source
      # This config file tells Grafana about Loki so you don't have to add it manually
      # See config/grafana-datasource.yaml for Loki connection details
      # On startup, Grafana reads this and automatically configures the Loki data source
      - ./config/grafana-datasource.yaml:/etc/grafana/provisioning/datasources/loki.yaml
    
    # Same network so Grafana can query Loki at http://loki:3100
    networks:
      - loki-network
    
    # Wait for Loki to be healthy before starting Grafana
    # Ensures data source connection works immediately
    depends_on:
      loki:
        condition: service_healthy
    
    restart: unless-stopped
    
    # Health check: Grafana has an API endpoint that reports its health
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

# ===========================================
# NETWORK
# ===========================================
# Private Docker network for service-to-service communication
networks:
  loki-network:
    # Bridge driver: default, creates a private network
    # Services can reach each other by container name (e.g., http://loki:3100)
    driver: bridge
    # Explicit name makes it easier to identify in `docker network ls`
    name: loki-network

# ===========================================
# VOLUMES
# ===========================================
# Named volumes for persistent data that survives container restarts
volumes:
  # Loki's log storage (chunks and index)
  # Contains actual log data compressed and indexed
  # Delete this to clear all stored logs
  loki-data:
    name: loki-data
  
  # Grafana's application data
  # Contains dashboards, user accounts, datasources config, plugins
  # Delete this to reset Grafana to factory defaults
  grafana-data:
    name: grafana-data
  
  # Promtail's positions tracking file
  # Small file that tracks file positions (which lines already read)
  # Critical for avoiding duplicate log entries after restart
  # Delete this to force Promtail to re-read all log files from start
  promtail-positions:
    name: promtail-positions
